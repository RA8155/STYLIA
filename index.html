<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STYLIA - M-commerce de Estilo Inteligente</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuraci√≥n de fuente y modo oscuro */
        :root {
            --color-primary: #8a2be2; /* Azul violeta para STYLIA (Blue Violet) */
            --color-secondary: #ff69b4; /* Rosa brillante (Hot Pink) */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* Fondo ligero */
        }
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        /* Clase para el bot√≥n de navegaci√≥n activo */
        .nav-active {
            color: var(--color-primary);
            border-top: 2px solid var(--color-primary);
        }
        /* Estilos personalizados para la est√©tica STYLIA */
        .stylia-card {
            background-color: #ffffff;
            border-radius: 1.25rem; /* rounded-2xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
            transition: transform 0.3s ease;
        }
        
        /* PRIMARY BUTTON STYLES (Gradiente) */
        .stylia-btn-primary {
            background-image: linear-gradient(to right, var(--color-primary), #6a1b9a);
            color: white;
            border: none;
            transition: all 0.2s;
        }
        .stylia-btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .stylia-btn-primary:active { /* Efecto de presi√≥n */
            transform: scale(0.98);
            box-shadow: none;
            opacity: 0.8;
        }

        /* SECONDARY BUTTON STYLES (Borde o Outline) */
        .stylia-btn-secondary {
            transition: all 0.2s;
            line-height: 1.2; /* Ajuste para evitar CLS en algunos botones */
        }
        .stylia-btn-secondary:hover {
            opacity: 0.9;
        }
        .stylia-btn-secondary:active { /* Efecto de presi√≥n */
            transform: scale(0.98);
            opacity: 0.7;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); /* Sombra de hundimiento sutil */
        }

        /* NAV BUTTON STYLES */
        .nav-button:active {
            transform: scale(0.95);
        }

        /* Estilo para simular la Realidad Aumentada */
        .ar-view {
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://placehold.co/400x300/4c1d95/ffffff?text=C√°mara+AR') center center / cover;
            min-height: 200px;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            border: 4px solid var(--color-primary);
        }

        /* Estilos para el Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 400px;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Barra de progreso simple para estad√≠sticas */
        .progress-bar-container {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: var(--color-secondary); /* Usa el color rosa para destacar */
            transition: width 0.5s ease-out;
        }

        /* Estilos para la selecci√≥n de colores */
        .color-option {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            transition: border-color 0.2s, transform 0.2s;
        }
        .color-option.selected {
            border-color: var(--color-primary);
            transform: scale(1.1);
        }
        .color-white {
            border: 1px solid #ddd;
        }
        
        /* Estilos para los radio buttons de TALLA y ESTILO */
        /* Estilo seleccionado para Estilo */
        .style-label-selected {
            background-color: var(--color-primary) !important;
            color: white !important;
            border-color: var(--color-primary) !important;
        }
        /* Estilo seleccionado para Talla */
        .size-label-selected {
            background-color: var(--color-secondary) !important;
            color: white !important;
            border-color: var(--color-secondary) !important;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'stylia-purple': '#8a2be2',
                        'stylia-pink': '#ff69b4',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">

    <!-- Indicador de Carga Global -->
    <div id="loading-indicator" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-70 text-white p-4 rounded-xl shadow-2xl z-50 hidden flex-col items-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-stylia-pink mb-2"></div>
        <span id="loading-message" class="text-sm font-semibold">Cargando...</span>
    </div>

    <!-- Toast Notification (Pop-up Temporal) -->
    <div id="toast-notification" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 p-3 bg-stylia-purple text-white text-sm font-semibold rounded-xl shadow-lg transition-opacity duration-300 z-50 opacity-0 pointer-events-none">
        Tu outfit estar√° listo en breve
    </div>

    <!-- Contenedor Principal de la App (Simulaci√≥n de M√≥vil) -->
    <div id="app" class="app-container mx-auto max-w-sm border-x border-gray-200 bg-gray-50">
        
        <!-- HEADER FIJO (ORIGINAL) -->
        <header id="appHeader" class="sticky top-0 bg-white border-b border-gray-100 shadow-sm p-4 z-10 flex justify-between items-center">
            <h1 id="headerTitle" class="text-xl font-extrabold text-stylia-purple flex items-center">
                STYLIA <span id="headerTagline" class="text-xs ml-2 text-gray-500 font-medium"></span>
            </h1>
            <!-- Icono de Notificaciones simple (sin contador) -->
            <button id="notificationButton" onclick="showModule('notificaciones')" class="text-2xl text-gray-500">
                üîî
            </button>
        </header>

        <!-- CONTENIDO DIN√ÅMICO DE LOS M√ìDULOS -->
        <main id="content" class="flex-grow p-4 space-y-4 pb-20 overflow-y-auto">
            <!-- El contenido de los m√≥dulos se inyectar√° aqu√≠ -->
        </main>

        <!-- BARRA DE NAVEGACI√ìN INFERIOR FIJA (6 elementos) -->
        <nav id="bottomNav" class="fixed bottom-0 left-0 right-0 mx-auto max-w-sm h-16 bg-white border-t border-gray-200 shadow-lg flex justify-around items-center z-20">
            <!-- Todos los botones ahora usan w-1/6 (approx.) -->
            <button onclick="showModule('look')" id="nav-look" class="flex flex-col items-center justify-center h-full w-[16.6%] text-gray-500 transition duration-150 ease-in-out nav-button">
                <span class="text-2xl">‚ú®</span>
                <span class="text-xs font-medium mt-0.5">Look</span>
            </button>
            <button onclick="showModule('armario')" id="nav-armario" class="flex flex-col items-center justify-center h-full w-[16.6%] text-gray-500 transition duration-150 ease-in-out nav-button">
                <span class="text-2xl">üóÑÔ∏è</span>
                <span class="text-xs font-medium mt-0.5">Armario</span>
            </button>
            <button onclick="showModule('estadisticas')" id="nav-estadisticas" class="flex flex-col items-center justify-center h-full w-[16.6%] text-gray-500 transition duration-150 ease-in-out nav-button">
                <span class="text-2xl">üìà</span>
                <span class="text-xs font-medium mt-0.5">Stats</span>
            </button>
            <button onclick="showModule('compra')" id="nav-compra" class="flex flex-col items-center justify-center h-full w-[16.6%] text-gray-500 transition duration-150 ease-in-out nav-button">
                <span class="text-2xl">üõçÔ∏è</span>
                <span class="text-xs font-medium mt-0.5">Comprar</span>
            </button>
            <button onclick="showModule('notificaciones')" id="nav-notificaciones" class="flex flex-col items-center justify-center h-full w-[16.6%] text-gray-500 transition duration-150 ease-in-out nav-button">
                <span class="text-2xl">üîî</span>
                <span class="text-xs font-medium mt-0.5">Alertas</span>
            </button>
            <button onclick="showModule('perfil')" id="nav-perfil" class="flex flex-col items-center justify-center h-full w-[16.6%] text-gray-500 transition duration-150 ease-in-out nav-button">
                <span class="text-2xl">üë§</span>
                <span class="text-xs font-medium mt-0.5">Perfil</span>
            </button>
        </nav>

    </div>

    <!-- Modal Principal (Ahora gen√©rico: Look, Detalles, Preferencias) -->
    <div id="mainModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content p-6" onclick="event.stopPropagation()">
            
            <!-- Contenido para el ASESOR DE IA (Existente) -->
            <div id="ai-advisor-view" class="hidden">
                <h3 class="text-xl font-bold text-stylia-purple mb-4 flex items-center">
                    ‚ú® Asesor de Outfit con IA
                </h3>
                <div id="look-form">
                    <div class="mb-4">
                        <label for="baseItem" class="block text-sm font-medium text-gray-700">Prenda Base:</label>
                        <select id="baseItem" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-stylia-purple focus:ring focus:ring-stylia-purple focus:ring-opacity-50 p-2 border">
                            <option value="Camiseta Blanca">Camiseta Blanca (Superior)</option>
                            <option value="Pantal√≥n Jeans Negro">Pantal√≥n Jeans Negro (Inferior)</option>
                            <option value="Chaqueta Vaquera">Chaqueta Vaquera (Exterior)</option>
                            <option value="Sudadera Oversize">Sudadera Oversize (Parte de arriba)</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label for="occasion" class="block text-sm font-medium text-gray-700">Ocasi√≥n:</label>
                        <input type="text" id="occasion" placeholder="Ej: Cena de aniversario, d√≠a de relax, reuni√≥n de trabajo" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-stylia-purple focus:ring focus:ring-stylia-purple focus:ring-opacity-50 p-2 border">
                    </div>
                    <button onclick="generateOutfitAdvice()" class="stylia-btn-primary w-full p-3 rounded-full text-sm font-semibold">
                        Generar Look con IA
                    </button>
                </div>
                
                <div id="look-result" class="mt-4 hidden">
                    <h4 class="font-bold text-lg text-stylia-pink mb-2">Look Recomendado:</h4>
                    <div id="result-text" class="p-3 bg-gray-50 rounded-lg text-sm text-gray-700 whitespace-pre-wrap"></div>
                    <button onclick="closeModal()" class="w-full text-stylia-purple p-3 rounded-full text-sm font-semibold border border-stylia-purple/50 bg-stylia-purple/5 mt-4 stylia-btn-secondary">
                        Cerrar
                    </button>
                </div>
            </div>

            <!-- Contenido para VER DETALLES DE OUTFIT SIMPLE (Existente) -->
            <div id="simple-details-view" class="hidden">
                <!-- T√≠tulo din√°mico para el outfit -->
                <h3 id="simple-details-title" class="text-xl font-bold text-stylia-pink mb-4 flex items-center"></h3>
                
                <!-- Contenedor de Imagen y Carga -->
                <div id="image-container" class="w-full h-64 bg-gray-200 rounded-xl mb-4 border-2 border-stylia-purple/50 flex items-center justify-center relative">
                    <img id="simple-details-image" src="" alt="Imagen del Outfit" class="w-full h-full object-cover rounded-xl hidden">
                    <div id="image-loading" class="flex flex-col items-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-stylia-purple mb-2"></div>
                        <span class="text-sm text-gray-600 font-semibold">Generando imagen con IA...</span>
                    </div>
                    <p id="image-error" class="text-sm text-red-600 font-semibold p-4 text-center hidden">
                        ‚ö†Ô∏è No se pudo cargar la imagen.
                    </p>
                </div>
                
                <!-- Lista de Prendas -->
                <div id="simple-details-list" class="p-4 bg-gray-50 rounded-lg mb-4 text-gray-700"></div>

                <!-- Bot√≥n de Cierre -->
                <button onclick="closeModal()" class="w-full stylia-btn-primary p-3 rounded-full text-sm font-semibold">
                    Entendido
                </button>
            </div>
            
            <!-- Contenido para EDICI√ìN DE PREFERENCIAS (NUEVO) -->
            <div id="preferences-view" class="hidden">
                <!-- El contenido del formulario se inyectar√° aqu√≠ -->
            </div>

        </div>
    </div>


    <script>
        // --- CONSTANTES Y UTILIDADES DE GEMINI API ---
        const API_KEY = "";
        
        // Configuraci√≥n para Generaci√≥n de Texto (Asesor)
        const TEXT_MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL_NAME}:generateContent?key=${API_KEY}`;
        
        // --- ESTADO DE LA APLICACI√ìN (Variables de Perfil) ---
        let userName = 'M√≥nica L√≥pez';
        let userEmail = 'monica.lopez@gmail.com';
        let memberSince = 'Octubre 2025';
        // Variables de preferencias (interactivas)
        let currentStyle = 'Casual Chic';
        let tshirtSize = 'M';
        let favoriteColors = ['#ff69b4', '#FFFFFF', '#3B82F6']; // Rosa, Blanco, Azul

        // --- ESTADO DEL M√ìDULO ARMARIO (Nuevo) ---
        let currentArmarioFilter = 'Todo'; 
        
        // --- ESTADO DE AUTENTICACI√ìN (NUEVO) ---
        let isLoggedIn = true; // Asumimos que el usuario est√° logueado al inicio

        // --- OPCIONES PARA EL MODAL DE PREFERENCIAS ---
        const styleOptions = ['Casual Chic', 'Minimalista', 'Deportivo', 'Bohemio', 'Elegante', 'Urbano'];
        const sizeOptions = ['XS', 'S', 'M', 'L', 'XL', 'XXL'];
        const availableColors = [
            { name: 'Rosa (Stylia)', hex: '#ff69b4' },
            { name: 'Blanco', hex: '#FFFFFF' },
            { name: 'Negro', hex: '#1F2937' },
            { name: 'Rojo', hex: '#EF4444' },
            { name: 'Azul', hex: '#3B82F6' },
            { name: 'Verde', hex: '#10B981' },
            { name: 'Violeta', hex: '#8a2be2' },
            { name: 'Naranja', hex: '#F97316' },
        ];


        // Funci√≥n para mostrar/ocultar el indicador de carga global
        function showLoading(message = 'Generando sugerencia...') {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('loading-indicator').classList.add('flex');
        }

        function hideLoading() {
            document.getElementById('loading-indicator').classList.remove('flex');
            document.getElementById('loading-indicator').classList.add('hidden');
        }
        
        // --- Utilidad de Toast Notification (A√±adido) ---
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            if (!toast) return;

            toast.textContent = message;
            
            // Muestra el toast
            toast.classList.remove('opacity-0', 'pointer-events-none', 'bg-red-500');
            // Determinar si es un mensaje de error o √©xito/info
            const isError = message.includes('‚ö†Ô∏è') || message.includes('‚ùå');
            if (isError) {
                toast.classList.add('bg-red-500'); // Fondo rojo para errores
            } else {
                // Quita clases de error si estaban
                toast.classList.remove('bg-red-500');
                toast.classList.add('bg-stylia-purple'); // Fondo por defecto
            }

            toast.classList.add('opacity-100');

            // Oculta el toast despu√©s de 5 segundos (5000ms)
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0', 'pointer-events-none');
            }, 5000); 
        }

        /**
         * Llama a la API de generaci√≥n de texto con backoff exponencial.
         */
        async function callGeminiApi(userQuery, systemPrompt, retries = 3) {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(TEXT_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        return text;
                    } else {
                        throw new Error('No content generated by the model.');
                    }

                } catch (error) {
                    console.error('Gemini API Error:', error);
                    if (i === retries - 1) throw error; // Re-throw error after last retry
                }
            }
        }
        
        // --- Utilidades para la UI (Header/Nav) ---
        const appHeader = document.querySelector('header');
        const headerTitle = appHeader.querySelector('h1');
        const notificationButton = appHeader.querySelector('button');
        const bottomNav = document.querySelector('nav');
        
        // --- L√ìGICA DE AUTENTICACI√ìN (NUEVO) ---
        function handleLogout() {
            isLoggedIn = false;
            showToast('Sesi√≥n cerrada. ¬°Vuelve pronto!');
            // Ocultar barra de navegaci√≥n
            bottomNav.classList.add('hidden');
            // Ajustar el encabezado
            headerTitle.innerHTML = 'STYLIA'; // Quitar el tagline
            notificationButton.classList.add('hidden');
            // Forzar la vista a la pantalla de autenticaci√≥n
            showModule('auth');
        }

        function handleLoginOrRegister() {
            isLoggedIn = true;
            showToast('¬°Bienvenido de nuevo, M√≥nica!');
            // Restaurar la interfaz de usuario
            bottomNav.classList.remove('hidden');
            headerTitle.innerHTML = 'STYLIA <span class="text-xs ml-2 text-gray-500 font-medium"></span>';
            notificationButton.classList.remove('hidden');
            // Volver a la vista predeterminada
            showModule('look'); 
        }

        // --- L√ìGICA DE LA APP Y M√ìDULOS EXISTENTES ---
        const contentDiv = document.getElementById('content');
        const navButtons = {
            'look': document.getElementById('nav-look'),
            'armario': document.getElementById('nav-armario'),
            'estadisticas': document.getElementById('nav-estadisticas'), 
            'compra': document.getElementById('nav-compra'),
            'notificaciones': document.getElementById('nav-notificaciones'),
            'perfil': document.getElementById('nav-perfil'), 
        };

        // --- Datos de Ejemplo (Mock Data) ---
        // MODIFICACI√ìN: Se a√±ade el campo 'category' para permitir el filtrado granular.
        const mockInventory = [
            { id: 1, name: 'Camiseta Blanca', type: 'Superior', category: 'Camisetas y Blusas', color: 'Blanco', uses: 15, lastUsed: 'Ayer', needsWash: true, imageUrl: 'https://placehold.co/100x100/eeeeee/333333?text=T-Shirt' },
            { id: 2, name: 'Pantal√≥n Jeans Negro', type: 'Inferior', category: 'Pantalones y Faldas', color: 'Negro', material: 'Denim', uses: 12, lastUsed: 'Hace 3 d√≠as', needsWash: false, imageUrl: 'https://placehold.co/100x100/444444/ffffff?text=Jeans' },
            { id: 3, name: 'Chaqueta Vaquera', type: 'Exterior', category: 'Abrigos y Chaquetas', color: 'Azul Denim', material: 'Denim', uses: 2, lastUsed: 'Hace 4 meses', needsWash: false, imageUrl: 'https://placehold.co/100x100/5c7b9e/ffffff?text=Denim+Jacket' },
            // Se transforma la Camiseta Oversize a una Sudadera para demostrar el filtro
            { id: 4, name: 'Sudadera Oversize', type: 'Superior', category: 'Sudaderas', color: 'Gris', material: 'Algod√≥n', uses: 20, lastUsed: 'Ayer', needsWash: false, imageUrl: 'https://placehold.co/100x100/cccccc/333333?text=Hoodie' }, 
            { id: 5, name: 'Blusa de Seda Roja', type: 'Superior', category: 'Camisetas y Blusas', color: 'Rojo', uses: 1, lastUsed: 'Hace 6 meses', needsWash: false, imageUrl: 'https://placehold.co/100x100/a30000/ffffff?text=Blouse' },
        ];
        
        // Transforma el inventario en un string para el prompt de IA
        const inventoryContext = mockInventory.map(item => 
            `ID ${item.id}: ${item.name} (${item.type}, Color: ${item.color}, Usos: ${item.uses}${item.material ? ', Material: ' + item.material : ''}, √öltimo Uso: ${item.lastUsed})`
        ).join('\n');

        // Datos de notificaciones originales (sin el estado 'unread')
        const mockNotifications = [
            { type: 'look', icon: '‚ú®', title: 'Tiempo de hoy', content: 'El pron√≥stico es de 25¬∞C y sol.', time: 'Hace 5 min' },
            { type: 'maint', icon: 'üß∫', title: 'Recordatorio de Mantenimiento', content: 'Tu Camiseta Blanca ya se ha usado 3 veces. Es hora de lavarla.', time: 'Hace 1 hora' },
            { type: 'offer', icon: 'üè∑Ô∏è', title: 'Oferta Personalizada (-20%)', content: 'La chaqueta negra que viste en ASOS ahora tiene un descuento del 20% en tu talla.', time: 'Ayer' },
            { type: 'alert', icon: 'üö®', title: 'Alerta de Inventario', content: 'Parece que no has usado tu Chaqueta Vaquera en 4 meses.', time: 'Hace 2 d√≠as' },
        ];
        
        // --- Datos y L√≥gica Espec√≠fica del M√≥dulo LOOK ---
        const eventOptions = [
            { value: 'Reunion_Formal', label: 'Reuni√≥n üíº', outfitName: 'Traje Ejecutivo Cl√°sico', 
                items: [{ name: 'Blazer: Gris o gris carb√≥n', detail: '' }, { name: 'Blusa: Blanco roto', detail: '' }, { name: 'Falda: Gris o gris carb√≥n', detail: '' }] },
            { value: 'Dia_Relax', label: 'D√≠a de Relax üõãÔ∏è', outfitName: 'Ropa casual de domingo', 
                items: [{ name: 'Sudadera Oversize', detail: '' }, { name: 'Joggers Grises', detail: '' }] },
            { value: 'Cena_Amigos', label: 'Cena ü•Ç', outfitName: 'Outfit de Noche', 
                items: [{ name: 'Blusa de Seda: Rojo', detail: '' }, { name: 'Pantal√≥n Skinny: Negro', detail: '' }] },
            { value: 'Gimnasio', label: 'Gimnasio üí™', outfitName: 'Outfit de Gym', 
                items: [{ name: 'Top Deportivo: Negro', detail: '' }, { name: 'Leggings Transpirables', detail: '' }] }
        ];
        let currentEvent = eventOptions[0].value; // Evento seleccionado por defecto
        
        // --- Nuevos Outfits de Fallback para la secci√≥n "Ayuda" (AHORA CON IMAGEN EST√ÅTICA) ---
        const fallbackOutfits = [
            { 
                id: 1, 
                name: 'C√≥modo', 
                type: 'Casual', 
                items: ['Camisa Oversize de Rayas', 'Jeans Anchos'], 
                icon: 'üõèÔ∏è', 
                promptDescription: 'a black fitted blazer, a white silk shirt, dark wash straight denim jeans, and low-heeled booties. Modern office setting.',
                staticImageUrl: 'https://images.pexels.com/photos/1570768/pexels-photo-1570768.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=500' // URL de tu imagen de Oficina
            },
            { 
                id: 2, 
                name: 'Elegante', 
                type: 'Glam', 
                items: ['Vestido midi ajustado de terciopelo azul'], 
                icon: '‚ú®', 
                promptDescription: 'a fitted blue velvet midi dress, black stiletto heels, and large gold drop earrings. Elegant party background.',
                staticImageUrl: 'https://images.pexels.com/photos/2253870/pexels-photo-2253870.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=500' // URL de tu imagen de C√≥ctel
            },
            { 
                id: 3, 
                name: 'Business casual', 
                type: 'Business', 
                items: ['C√°rdigan de punto', 'Pantal√≥n recto tobillero'], 
                icon: 'üíº', 
                promptDescription: 'an oversized beige sweatshirt, grey athletic joggers, white sneakers, and a baseball cap. Cozy home environment.',
                staticImageUrl: 'https://images.pexels.com/photos/3757943/pexels-photo-3757943.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=500' // URL de tu imagen de Relax
            },
            { 
                id: 4, 
                name: 'Look sofisticado', 
                type: 'Monocrom√°tico', 
                items: ['Camisa amplia de hombros ca√≠dos', 'Pantal√≥n recto'], 
                icon: 'üë†', 
                promptDescription: 'an oversized beige sweatshirt, grey athletic joggers, white sneakers, and a baseball cap. Cozy home environment.',
                staticImageUrl: 'https://images.pexels.com/photos/3757943/pexels-photo-3757943.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=500' // URL de tu imagen de Relax
            },
        ];


        // --- Funciones del Modal Gen√©rico ---
        /**
         * Abre el modal y establece el modo de vista (AI, Detalles Simples, o Preferencias).
         * @param {string} mode - 'ai', 'details', o 'preferences'
         */
        function openMainModal(mode = 'ai') {
            document.getElementById('mainModal').style.display = 'flex';
            
            const aiView = document.getElementById('ai-advisor-view');
            const simpleView = document.getElementById('simple-details-view');
            const preferencesView = document.getElementById('preferences-view');

            // Ocultar todas las vistas
            aiView.classList.add('hidden');
            simpleView.classList.add('hidden');
            preferencesView.classList.add('hidden');

            if (mode === 'ai') {
                aiView.classList.remove('hidden');
                document.getElementById('look-form').classList.remove('hidden');
                document.getElementById('look-result').classList.add('hidden');
            } else if (mode === 'details') {
                simpleView.classList.remove('hidden');
            } else if (mode === 'preferences') {
                preferencesView.classList.remove('hidden');
                // Inyectar el formulario de preferencias
                preferencesView.innerHTML = renderPreferencesForm();
                // Inicializar la selecci√≥n de colores despu√©s de renderizar el HTML
                setTimeout(initializeColorSelection, 0); 
            }
        }

        function closeModal() {
            document.getElementById('mainModal').style.display = 'none';
        }

        /**
         * Muestra los detalles de un outfit simple (con imagen EST√ÅTICA) en el modal.
         * @param {number} outfitId - El ID del outfit en fallbackOutfits.
         */
        function showOutfitDetails(outfitId) {
            const outfit = fallbackOutfits.find(o => o.id === outfitId);
            if (!outfit) return;

            // Elementos del Modal
            const imgElement = document.getElementById('simple-details-image');
            const imgLoading = document.getElementById('image-loading');
            const imgError = document.getElementById('image-error');

            // 1. Prepara la UI: Inyecta t√≠tulo y lista de prendas
            document.getElementById('simple-details-title').innerHTML = `${outfit.icon} ${outfit.name}`;
            
            const itemsHTML = `
                <p class="font-bold text-stylia-purple mb-2">Prendas Clave:</p>
                <ul class="list-disc pl-5 space-y-1 text-sm">
                    ${outfit.items.map(item => `<li>${item}</li>`).join('')}
                </ul>
            `;
            document.getElementById('simple-details-list').innerHTML = itemsHTML;

            // 2. Muestra el modal en modo 'details'
            openMainModal('details');

            // 3. Carga la imagen est√°tica y actualiza el estado de la UI
            const imageUrl = outfit.staticImageUrl;
            imgElement.src = imageUrl;
            
            // Oculta el indicador de carga y el error, muestra la imagen.
            imgLoading.classList.add('hidden');
            imgError.classList.add('hidden');
            imgElement.classList.remove('hidden'); 
        }


        // --- FUNCI√ìN GEMINI: ASESOR DE OUTFIT (M√≥dulo Look) ---
        async function generateOutfitAdvice() {
            const baseItem = document.getElementById('baseItem').value;
            const occasion = document.getElementById('occasion').value;
            
            if (!baseItem || !occasion) {
                console.error('Error: Por favor, selecciona una prenda base e introduce una ocasi√≥n.');
                return;
            }

            const systemPrompt = `Act√∫a como un estilista de moda personal, experto en crear outfits funcionales y est√©ticos. Tu √∫nica fuente de prendas es el inventario provisto. Debes crear un look completo (Superior, Inferior, Calzado, y un Accesorio/Exterior opcional) usando la prenda base indicada y el inventario disponible. Nombra el look, explica la elecci√≥n de las prendas y ofrece un consejo de estilo final. Usa un tono moderno y amigable.`;
            
            const userQuery = `Mi inventario es:\n${inventoryContext}\n\nQuiero usar la prenda base: "${baseItem}" para la ocasi√≥n: "${occasion}". ¬øQu√© look completo de STYLIA me sugieres?`;
            
            showLoading('Analizando tu armario y ocasi√≥n...');
            document.getElementById('look-form').classList.add('hidden');

            try {
                const resultText = await callGeminiApi(userQuery, systemPrompt);
                document.getElementById('result-text').textContent = resultText;
                document.getElementById('look-result').classList.remove('hidden');
            } catch (error) {
                document.getElementById('result-text').textContent = "‚ö†Ô∏è Error al conectar con el Asesor de IA. Int√©ntalo de nuevo m√°s tarde.";
                document.getElementById('look-result').classList.remove('hidden');
                console.error("Error en la generaci√≥n del outfit:", error);
            } finally {
                hideLoading();
            }
        }

        // --- FUNCI√ìN GEMINI: ASISTENTE DE CUIDADO DE PRENDAS (M√≥dulo Armario) ---
        async function askMaintenanceAdvice(item) {
            const systemPrompt = `Act√∫a como un asistente de mantenimiento y cuidado de prendas experto. Proporciona consejos espec√≠ficos de lavado, secado y almacenamiento para la prenda indicada, bas√°ndose en su tipo y material (si est√° disponible). S√© conciso y pr√°ctico, usando emojis.`;
            
            const itemDetails = mockInventory.find(i => i.name === item);
            if (!itemDetails) return; // No debe ocurrir con la l√≥gica actual

            const userQuery = `Prenda: ${itemDetails.name}. Tipo: ${itemDetails.type}. Color: ${itemDetails.color}. Material: ${itemDetails.material || 'No especificado'}.`;
            
            // Simulaci√≥n de respuesta directa, no modal
            const resultElementId = `maintenance-result-${itemDetails.id}`;
            document.getElementById(resultElementId).textContent = "Consultando con la IA de Mantenimiento...";
            document.getElementById(resultElementId).classList.remove('hidden');
            
            try {
                const resultText = await callGeminiApi(userQuery, systemPrompt);
                document.getElementById(resultElementId).textContent = resultText;
            } catch (error) {
                document.getElementById(resultElementId).textContent = "‚ö†Ô∏è Error al obtener el consejo de mantenimiento. Vuelve a intentarlo.";
                console.error("Error en la generaci√≥n del consejo:", error);
            }
        }
        
        // --- L√ìGICA ESPEC√çFICA DEL M√ìDULO ARMARIO (Nuevo Filtro) ---
        /**
         * Actualiza el filtro del armario y re-renderiza el m√≥dulo.
         * @param {string} filter - Las categor√≠as: 'Todo', 'Camisetas y Blusas', 'Sudaderas', 'Pantalones y Faldas', 'Abrigos y Chaquetas', 'Necesita Lavado'.
         */
        function filterArmario(filter) {
            // Solo re-renderiza si el filtro ha cambiado
            if (currentArmarioFilter !== filter) {
                currentArmarioFilter = filter;
                showModule('armario'); 
            }
        }

        
        // --- FUNCIONES DIN√ÅMICAS DEL M√ìDULO LOOK ---
        
        /**
         * Renderiza el contenido din√°mico del Look Recomendado.
         * @param {string} eventValue - El valor del evento seleccionado (p.e., 'Reunion_Formal').
         * @returns {string} HTML con los detalles del look.
         */
        function renderLookDetails(eventValue) {
            const look = eventOptions.find(opt => opt.value === eventValue);
            if (!look) return '';

            return `
                <div class="flex space-x-4 items-start">
                    <!-- Outfit Visual Block (Estilo de la Imagen) -->
                    <div class="w-24 h-24 rounded-xl flex items-center justify-center text-stylia-purple font-bold text-lg p-2 shadow-lg flex-shrink-0" style="background-image: linear-gradient(135deg, #a78bfa, #8a2be2); color: white;">
                        Look
                    </div>

                    <!-- Detalles del Look -->
                    <div class="flex-grow">
                        <p id="look-name" class="text-xl font-extrabold text-gray-800 mb-2">${look.outfitName}</p>
                        <ul id="look-items" class="text-sm text-gray-600 list-disc pl-5 space-y-1">
                            ${look.items.map(item => `
                                <li>
                                    ${item.name} <span class="text-xs text-gray-500">${item.detail}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>

                <!-- Bot√≥n Principal (Preparar Outfit Ahora) - Modificado para mostrar el Toast -->
                <button onclick="showToast('Tu outfit estar√° listo en breve')" class="stylia-btn-primary w-full p-3 rounded-xl text-lg font-bold flex items-center justify-center mt-4">
                    Preparar Outfit Ahora
                </button>

                <!-- Texto Secundario (Llamada al Modal No S√© Qu√© Ponerme) -->
                <button onclick="openMainModal('ai')" class="w-full text-sm font-semibold text-stylia-purple/80 hover:text-stylia-purple transition stylia-btn-secondary p-1">
                </button>
            `;
        }

        /**
         * Actualiza el look recomendado en la UI al cambiar la selecci√≥n del evento.
         * @param {string} eventValue - El valor del evento seleccionado.
         */
        function updateLookRecommendation(eventValue) {
            currentEvent = eventValue;
            const detailsContainer = document.getElementById('recommendedLookDetails');
            if (detailsContainer) {
                detailsContainer.innerHTML = renderLookDetails(eventValue);
            }
            
            // Tambi√©n actualiza la etiqueta del evento en el contexto
            const eventLabel = eventOptions.find(opt => opt.value === eventValue).label;
            document.getElementById('selectedEventLabel').textContent = eventLabel;
        }

        // --- FUNCIONES DEL MODAL DE PREFERENCIAS (NUEVAS) ---

        /**
         * Abre el modal para editar las preferencias del usuario.
         */
        function openPreferencesModal() {
            openMainModal('preferences');
        }

        /**
         * Alterna la selecci√≥n de un color en el modal de preferencias, con l√≠mite de 3.
         * @param {HTMLElement} element - El elemento del color clicado.
         */
        function toggleColorSelection(element) {
            const isCurrentlySelected = element.classList.contains('selected');
            const selectedCount = document.querySelectorAll('#preferences-view .color-option.selected').length;

            if (isCurrentlySelected) {
                // Si ya est√° seleccionado, lo deselecciona
                element.classList.remove('selected');
            } else {
                // Si no est√° seleccionado, verifica el l√≠mite
                if (selectedCount >= 3) {
                    showToast('‚ùå Solo puedes seleccionar un m√°ximo de 3 colores favoritos.');
                    return; // No permite la selecci√≥n
                }
                // Si no se supera el l√≠mite, selecciona
                element.classList.add('selected');
            }
        }
        
        /**
         * Funci√≥n para manejar la selecci√≥n de radio buttons (Estilo/Talla)
         * para aplicar las clases de color inmediatamente.
         * @param {string} groupName - 'styleOption' o 'sizeOption'.
         * @param {HTMLElement} targetLabel - La etiqueta del elemento radio seleccionado.
         */
        function handleRadioSelection(groupName, targetLabel) {
            // 1. Quitar la clase de seleccionado a todos los radios del grupo
            const allLabels = document.querySelectorAll(`input[name="${groupName}"]`);
            allLabels.forEach(input => {
                const label = input.closest('label');
                if (label) {
                    label.classList.remove('style-label-selected', 'size-label-selected');
                }
            });

            // 2. A√±adir la clase de seleccionado al elemento clicado
            if (groupName === 'styleOption') {
                targetLabel.classList.add('style-label-selected');
            } else if (groupName === 'sizeOption') {
                targetLabel.classList.add('size-label-selected');
            }
        }

        /**
         * Inicializa la selecci√≥n visual de colores y radios en el formulario.
         */
        function initializeColorSelection() {
            // Inicializa la selecci√≥n de colores (borde)
            const colorElements = document.querySelectorAll('#preferences-view .color-option');
            colorElements.forEach(el => {
                const hex = el.getAttribute('data-hex');
                if (favoriteColors.includes(hex)) {
                    el.classList.add('selected');
                }
            });

            // Inicializa la selecci√≥n de estilos (color de fondo)
            const styleRadios = document.querySelectorAll('input[name="styleOption"]');
            styleRadios.forEach(input => {
                if (input.value === currentStyle) {
                    input.closest('label').classList.add('style-label-selected');
                }
            });

            // Inicializa la selecci√≥n de tallas (color de fondo)
            const sizeRadios = document.querySelectorAll('input[name="sizeOption"]');
            sizeRadios.forEach(input => {
                if (input.value === tshirtSize) {
                    input.closest('label').classList.add('size-label-selected');
                }
            });
        }

        /**
         * Guarda las preferencias seleccionadas en el estado global y recarga el m√≥dulo Perfil.
         */
        function savePreferences() {
            // 1. Obtener Estilo
            const selectedStyle = document.querySelector('input[name="styleOption"]:checked');
            if (selectedStyle) {
                currentStyle = selectedStyle.value;
            }

            // 2. Obtener Talla
            const selectedSize = document.querySelector('input[name="sizeOption"]:checked');
            if (selectedSize) {
                tshirtSize = selectedSize.value;
            }

            // 3. Obtener Colores Favoritos
            const selectedColors = Array.from(document.querySelectorAll('#preferences-view .color-option.selected'))
                                       .map(el => el.getAttribute('data-hex'));
            favoriteColors = selectedColors;

            // 4. Cerrar Modal y Recargar M√≥dulo Perfil
            closeModal();
            showModule('perfil');
            showToast('‚úÖ ¬°Preferencias actualizadas con √©xito!');
        }

        /**
         * Renderiza el formulario de edici√≥n de preferencias.
         * @returns {string} HTML del formulario.
         */
        function renderPreferencesForm() {
            // Estilos
            const styleOptionsHTML = styleOptions.map(style => `
                <label 
                    class="inline-flex items-center m-1 p-2 rounded-full cursor-pointer transition border border-gray-300 bg-gray-100 text-gray-700 hover:bg-stylia-purple/10"
                    onclick="handleRadioSelection('styleOption', this)"
                >
                    <input type="radio" name="styleOption" value="${style}" class="sr-only" ${currentStyle === style ? 'checked' : ''}>
                    <span class="text-sm font-medium">${style}</span>
                </label>
            `).join('');

            // Tallas
            const sizeOptionsHTML = sizeOptions.map(size => `
                <label 
                    class="inline-flex items-center m-1 p-2 w-10 h-10 rounded-full justify-center cursor-pointer transition border border-gray-300 bg-gray-100 text-gray-700 hover:bg-stylia-pink/10"
                    onclick="handleRadioSelection('sizeOption', this)"
                >
                    <input type="radio" name="sizeOption" value="${size}" class="sr-only" ${tshirtSize === size ? 'checked' : ''}>
                    <span class="text-sm font-bold">${size}</span>
                </label>
            `).join('');

            // Colores
            const colorOptionsHTML = availableColors.map(color => `
                <div 
                    class="color-option ${color.hex === '#FFFFFF' ? 'color-white' : ''}" 
                    style="background-color: ${color.hex};" 
                    data-hex="${color.hex}"
                    onclick="toggleColorSelection(this)"
                ></div>
            `).join('');


            return `
                <h3 class="text-2xl font-bold text-stylia-purple mb-6 text-center">
                    ‚úèÔ∏è Editar Preferencias
                </h3>

                <!-- SECCI√ìN ESTILO -->
                <div class="mb-6">
                    <label class="block text-base font-semibold text-gray-800 mb-3">Estilo Actual:</label>
                    <div class="flex flex-wrap">
                        ${styleOptionsHTML}
                    </div>
                </div>

                <!-- SECCI√ìN TALLA -->
                <div class="mb-6 border-t pt-4 border-gray-100">
                    <label class="block text-base font-semibold text-gray-800 mb-3">Talla de Camiseta (Top):</label>
                    <div class="flex flex-wrap space-x-1 justify-center">
                        ${sizeOptionsHTML}
                    </div>
                </div>

                <!-- SECCI√ìN COLORES -->
                <div class="mb-6 border-t pt-4 border-gray-100">
                    <label class="block text-base font-semibold text-gray-800 mb-3">Colores Favoritos (M√°x. 3):</label>
                    <p class="text-xs text-gray-500 mb-4">Selecciona hasta 3 colores para looks personalizados.</p>
                    <div class="flex flex-wrap gap-4 justify-center">
                        ${colorOptionsHTML}
                    </div>
                </div>

                <!-- Bot√≥n de Guardar -->
                <button onclick="savePreferences()" class="stylia-btn-primary w-full p-3 rounded-full text-lg font-semibold mt-4">
                    Guardar Cambios
                </button>
            `;
        }
        
        // --- RENDERIZADO DEL M√ìDULO DE AUTENTICACI√ìN (NUEVO) ---
        function renderAuthModule() {
            // Pantalla de autenticaci√≥n: Imagen de bienvenida y botones de acci√≥n.
            const authContent = `
                <div class="flex flex-col items-center justify-center min-h-[calc(100vh-64px)] p-4 text-center bg-gray-50">
                    
                    <h2 class="text-4xl font-extrabold text-stylia-purple mb-4 animate-pulse">
                        üëã STYLIA
                    </h2>

                    <!-- Imagen grande y estilizada (simulaci√≥n de banner) -->
                    <div class="stylia-card w-full p-4 mb-8 bg-white border-2 border-stylia-purple/50">
                        <img src="https://placehold.co/400x200/8a2be2/ffffff?text=Tu+Estilista+Personal+IA" 
                            alt="Ilustraci√≥n de Bienvenida" class="w-full rounded-xl object-cover shadow-lg">
                    </div>

                    <p class="text-xl font-semibold text-gray-800 mb-6">
                        Descubre tu pr√≥ximo look perfecto.
                    </p>
                    
                    <div class="w-full space-y-4 max-w-xs">
                        <!-- Bot√≥n Iniciar Sesi√≥n (Primario) -->
                        <button onclick="handleLoginOrRegister()" 
                                class="stylia-btn-primary w-full p-3 rounded-full text-lg font-semibold">
                            Iniciar Sesi√≥n
                        </button>
                        
                        <!-- Bot√≥n Registrar (Secundario) -->
                        <button onclick="handleLoginOrRegister()" 
                                class="w-full p-3 rounded-full text-lg font-semibold border-2 border-stylia-purple text-stylia-purple bg-white hover:bg-stylia-purple/5 transition stylia-btn-secondary">
                            Registrarme
                        </button>
                    </div>
                    
                    <p class="text-xs text-gray-400 mt-10">
                        Al continuar, aceptas nuestros t√©rminos de servicio.
                    </p>
                </div>
            `;
            return authContent;
        }


        // --- RENDERS DE M√ìDULOS ---

        function renderLookModule() {
            // Datos de la nueva estructura basados en la imagen
            const date = '23 de Octubre';
            const weather = '25¬∞C, Sol ‚òÄÔ∏è';
            
            // Renderiza el look inicial (currentEvent)
            const initialLookHTML = renderLookDetails(currentEvent);

            // Genera las opciones para el select
            const eventOptionsHTML = eventOptions.map(opt => `
                <option value="${opt.value}" ${opt.value === currentEvent ? 'selected' : ''}>
                    ${opt.label}
                </option>
            `).join('');


            const lookContent = `

                <!-- Contexto Diario Card (Ahora con Select para Evento) -->
                <section class="stylia-card p-5 mb-6 space-y-3 bg-white">
                    <h3 class="text-lg font-bold text-stylia-purple flex items-center mb-3">
                        üóìÔ∏è Informaci√≥n de hoy
                    </h3>
                    <div class="grid grid-cols-3 gap-4 text-sm text-gray-700">
                        <!-- Fecha -->
                        <div class="flex flex-col">
                            <p class="font-medium text-gray-500 text-xs">Fecha:</p>
                            <p class="font-semibold">${date}</p>
                        </div>
                        <!-- Clima -->
                        <div class="flex flex-col">
                            <p class="font-medium text-gray-500 text-xs">Tiempo:</p>
                            <p class="font-semibold">${weather}</p>
                        </div>
                        <!-- Evento (Ahora es un Dropdown) -->
                        <div class="flex flex-col col-span-3 md:col-span-1">
                            <label for="eventSelect" class="font-medium text-gray-500 text-xs mb-1">Elige tu Evento:</label>
                            <select id="eventSelect" onchange="updateLookRecommendation(this.value)"
                                class="w-full text-gray-800 font-semibold border-gray-300 rounded-lg p-1.5 border focus:border-stylia-purple focus:ring focus:ring-stylia-purple focus:ring-opacity-50 text-sm">
                                ${eventOptionsHTML}
                            </select>
                            <!-- Etiqueta de texto para mostrar el emoji en el mismo formato de antes -->
                            <p id="selectedEventLabel" class="font-semibold mt-1 hidden"></p> 
                        </div>
                    </div>
                </section>

                <!-- Tu Look Recomendado por IA Card (Contenido Din√°mico) -->
                <section class="stylia-card p-5 space-y-4 bg-white border border-stylia-purple/20">
                    <h3 class="text-xl font-extrabold text-stylia-purple">Tu look recomendado por IA</h3>
                    
                    <!-- Contenedor para inyectar los detalles del look, que se actualizar√° con JS -->
                    <div id="recommendedLookDetails">
                        ${initialLookHTML}
                    </div>

                </section>
                
                <!-- NUEVA SECCI√ìN: Ayuda No S√© Qu√© Ponerme (Ahora dentro de una tarjeta 'stylia-card') -->
                <section class="stylia-card p-5 space-y-4 mt-6 bg-white border border-gray-100">
                    <h2 class="text-xl font-extrabold mb-2 text-gray-800 flex items-center">
                        ¬°Ayuda! No s√© qu√© ponerme
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">
                        Explora sugerencias r√°pidas basadas en el estilo general.
                    </p>

                    <div class="grid grid-cols-2 gap-4">
                        ${fallbackOutfits.map(outfit => `
                            <!-- Tarjeta interna de outfit -->
                            <div class="p-4 flex flex-col items-center text-center hover:bg-gray-50 transition rounded-xl border border-gray-100">
                                <span class="text-3xl mb-2">${outfit.icon}</span>
                                <p class="text-sm font-semibold text-gray-800 truncate w-full">${outfit.name}</p>
                                <p class="text-xs text-gray-500 mt-1 h-8 overflow-hidden">${outfit.items.join(' + ')}</p>
                                <button onclick="showOutfitDetails(${outfit.id})" class="mt-3 text-xs text-stylia-pink border border-stylia-pink/50 bg-stylia-pink/5 p-1 rounded-full font-semibold w-full stylia-btn-secondary">
                                    Ver Detalles
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </section>
                <!-- FIN NUEVA SECCI√ìN -->

            `;
            return lookContent;
        }

        function renderArmarioModule() {
            // L√≥gica de filtrado de inventario
            let filteredInventory = mockInventory;
        
            if (currentArmarioFilter !== 'Todo' && currentArmarioFilter !== 'Necesita Lavado') {
                // MODIFICACI√ìN: Filtra por el nuevo campo 'category'
                filteredInventory = mockInventory.filter(item => item.category === currentArmarioFilter);
            } else if (currentArmarioFilter === 'Necesita Lavado') {
                // Filtra por necesidad de lavado (siempre se mantiene)
                filteredInventory = mockInventory.filter(item => item.needsWash);
            }
            
            // Funci√≥n auxiliar para clase activa del bot√≥n
            const getFilterClass = (filterName) => 
                currentArmarioFilter === filterName ? 
                'bg-stylia-purple text-white' : 
                'bg-gray-200 text-gray-700 hover:bg-gray-300';
            
            // M√≥dulo de Mi Armario Digital (Gesti√≥n de Inventario)
            const armarioContent = `
                <h2 class="text-2xl font-bold mb-4 text-stylia-purple">Mi Armario Digital (${filteredInventory.length} / ${mockInventory.length} prendas)</h2>

                <!-- Filtros y Opciones (INTERACTIVOS - MODIFICACI√ìN DE BOTONES) -->
                <div class="flex space-x-2 overflow-x-auto pb-3 mb-4">
                    <!-- Botones de filtro -->
                    <button onclick="filterArmario('Todo')" 
                            class="${getFilterClass('Todo')} px-3 py-1.5 rounded-full text-sm flex-shrink-0 stylia-btn-secondary">Todo</button>
                    <button onclick="filterArmario('Camisetas y Blusas')" 
                            class="${getFilterClass('Camisetas y Blusas')} px-3 py-1.5 rounded-full text-sm flex-shrink-0 stylia-btn-secondary">Camisetas y Blusas</button>
                    <button onclick="filterArmario('Sudaderas')" 
                            class="${getFilterClass('Sudaderas')} px-3 py-1.5 rounded-full text-sm flex-shrink-0 stylia-btn-secondary">Sudaderas</button>
                    <button onclick="filterArmario('Pantalones y Faldas')" 
                            class="${getFilterClass('Pantalones y Faldas')} px-3 py-1.5 rounded-full text-sm flex-shrink-0 stylia-btn-secondary">Pantalones y Faldas</button>
                    <button onclick="filterArmario('Abrigos y Chaquetas')" 
                            class="${getFilterClass('Abrigos y Chaquetas')} px-3 py-1.5 rounded-full text-sm flex-shrink-0 stylia-btn-secondary">Abrigos y Chaquetas</button>
                    <button onclick="filterArmario('Necesita Lavado')" 
                            class="${getFilterClass('Necesita Lavado')} px-3 py-1.5 rounded-full text-sm flex-shrink-0 stylia-btn-secondary">‚ö†Ô∏è ¬°A Lavar!</button>
                </div>

                <!-- Galer√≠a de Prendas -->
                <div class="space-y-3">
                    <!-- Sincronizaci√≥n en Tiempo Real -->
                    <div class="flex items-center text-sm text-green-600 bg-green-50 p-3 rounded-xl">
                        <span class="mr-2">üîÑ</span>
                        Sincronizado: √öltima actualizaci√≥n hace 5 segundos.
                    </div>
                    ${filteredInventory.length === 0 ? 
                        `<div class="text-center p-6 bg-white rounded-xl shadow-md text-gray-500">
                            No hay prendas en la categor√≠a seleccionada.
                        </div>` :
                        filteredInventory.map(item => `
                        <div class="stylia-card p-3 flex flex-col">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <img src="${item.imageUrl}" alt="${item.name}" class="w-14 h-14 rounded-lg object-cover">
                                    <div>
                                        <p class="text-base font-semibold text-gray-800">${item.name}</p>
                                        <p class="text-xs text-gray-500">Uso: ${item.lastUsed} | Material: ${item.material || 'N/A'} | Usos: ${item.uses}</p>
                                        ${item.needsWash ? '<span class="text-xs font-bold text-stylia-pink">‚ö†Ô∏è ¬°A lavar!</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- FUNCI√ìN GEMINI: Mantenimiento -->
                            <div class="mt-3 pt-3 border-t border-gray-100">
                                <button onclick="askMaintenanceAdvice('${item.name}')" class="w-full text-xs text-stylia-pink border border-stylia-pink/50 bg-stylia-pink/5 p-2 rounded-lg font-semibold flex items-center justify-center stylia-btn-secondary">
                                    ‚ú® Pedir Consejo de Cuidado
                                </button>
                                <div id="maintenance-result-${item.id}" class="mt-2 text-xs text-gray-600 p-2 bg-gray-100 rounded hidden whitespace-pre-wrap"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            return armarioContent;
        }

        function renderEstadisticasModule() {
            // M√≥dulo de Estad√≠sticas (Analytics)
            // Calcular estad√≠sticas simples
            const totalUses = mockInventory.reduce((sum, item) => sum + item.uses, 0);
            const mostUsedItem = mockInventory.reduce((max, item) => item.uses > max.uses ? item : max, { uses: -1, name: 'N/A' });
            const leastUsedItem = mockInventory.reduce((min, item) => item.uses < min.uses ? item : min, { uses: Infinity, name: 'N/A' });
            const avgUses = totalUses / mockInventory.length;
            const utilizationRate = Math.round((totalUses / (mockInventory.length * 50)) * 100); // Tasa de uso basado en un potencial de 50 usos por prenda
            
            const statsContent = `
                <!-- Resumen de Uso General -->
                <section class="stylia-card p-5 mb-6 space-y-3">
                    <h3 class="text-lg font-bold text-stylia-pink">Resumen Global (√öltimos 30 d√≠as)</h3>
                    <div class="flex justify-around text-center">
                        <div>
                            <p class="text-3xl font-extrabold text-stylia-purple">${totalUses}</p>
                            <p class="text-sm text-gray-500">Total de Usos</p>
                        </div>
                        <div>
                            <p class="text-3xl font-extrabold text-stylia-purple">${mockInventory.length}</p>
                            <p class="text-sm text-gray-500">Prendas en Armario</p>
                        </div>
                        <div>
                            <p class="text-3xl font-extrabold text-stylia-purple">${Math.round(avgUses)}</p>
                            <p class="text-sm text-gray-500">Uso Promedio</p>
                        </div>
                    </div>
                </section>

                <!-- Barra de Utilizaci√≥n del Armario -->
                <section class="stylia-card p-5 mb-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-3">Tasa de Rotaci√≥n</h3>
                    <p class="text-sm text-gray-600 mb-2">Tu armario se ha utilizado al <span class="font-bold text-stylia-pink">${utilizationRate}%</span> de su potencial.</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${utilizationRate}%;"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Sube este porcentaje con los looks sugeridos por IA.</p>
                </section>


                <!-- Prendas M√°s/Menos Usadas -->
                <section class="stylia-card p-5 space-y-4">
                    <h3 class="text-lg font-bold text-gray-800">Prendas Destacadas</h3>
                    
                    <!-- M√°s Usada -->
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ü•á</span>
                            <div>
                                <p class="text-sm font-semibold">${mostUsedItem.name}</p>
                                <p class="text-xs text-gray-500">M√°s usada: ${mostUsedItem.uses} veces</p>
                            </div>
                        </div>
                        <button class="text-xs text-stylia-purple border border-stylia-purple/50 bg-stylia-purple/5 p-1 rounded font-semibold stylia-btn-secondary">
                            Ver Looks
                        </button>
                    </div>

                    <!-- Menos Usada (Aleta de Inactividad) -->
                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ü•∂</span>
                            <div>
                                <p class="text-sm font-semibold text-red-700">${leastUsedItem.name}</p>
                                <p class="text-xs text-red-500">¬°Solo ${leastUsedItem.uses} uso! Inactiva.</p>
                            </div>
                        </div>
                        <button class="text-xs text-stylia-pink border border-stylia-pink/50 bg-stylia-pink/5 p-1 rounded font-semibold stylia-btn-secondary">
                            Sugerir Look
                        </button>
                    </div>
                </section>
            `;
            return statsContent;
        }

        function renderCompraModule() {
            // M√≥dulo de Compra del Armario STYLIA y Onboarding (Atracci√≥n)
            const compraContent = `
                <h2 class="text-2xl font-bold mb-4 text-stylia-purple">Comprar prendas de ropa üõçÔ∏è</h2>

                <section class="stylia-card p-5 space-y-4">
                    <p class="text-sm text-gray-600">En base a tus looks m√°s usados, te recomendamos:</p>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Producto 1 -->
                        <div class="stylia-card p-3 shadow-md">
                            <img src="https://placehold.co/200x200/4CAF50/ffffff?text=Falda+Plisada" class="w-full h-32 object-cover rounded-xl mb-2">
                            <p class="text-sm font-semibold truncate">Falda Plisada Verde</p>
                            <p class="text-xs text-stylia-pink font-bold">49.99 ‚Ç¨</p>
                            <button class="w-full text-xs text-stylia-purple border border-stylia-purple/50 bg-stylia-purple/5 p-1 rounded-full mt-2 stylia-btn-secondary">A√±adir al Carrito</button>
                        </div>
                        <!-- Producto 2 -->
                        <div class="stylia-card p-3 shadow-md">
                            <img src="https://placehold.co/200x200/9b59b6/ffffff?text=Jersey+Cashmere" class="w-full h-32 object-cover rounded-xl mb-2">
                            <p class="text-sm font-semibold truncate">Jersey Cashmere Malva</p>
                            <p class="text-xs text-stylia-pink font-bold">79.50 ‚Ç¨</p>
                            <button class="w-full text-xs text-stylia-purple border border-stylia-purple/50 bg-stylia-purple/5 p-1 rounded-full mt-2 stylia-btn-secondary">A√±adir al Carrito</button>
                        </div>
                    </div>
                </section>
            `;
            return compraContent;
        }

        function renderNotificacionesModule() {
            // M√≥dulo de Notificaciones y Alertas (Engagement)
            // Se mantiene simple, sin contador de no le√≠dos.

            const notifContent = `
                <h2 class="text-2xl font-bold mb-4 text-stylia-purple">Alertas y Notificaciones</h2>

                <div class="space-y-3">
                    ${mockNotifications.map(notif => `
                        <div class="stylia-card p-4 flex items-start space-x-3 border-l-4 border-gray-200">
                            <span class="text-2xl pt-1 flex-shrink-0">${notif.icon}</span>
                            <div>
                                <p class="text-sm font-bold text-gray-800">${notif.title}</p>
                                <p class="text-sm text-gray-600">${notif.content}</p>
                                <p class="text-xs text-gray-400 mt-1">${notif.time}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            return notifContent;
        }

        function renderPerfilModule() {
            // Generar los c√≠rculos de colores
            const colorCirclesHTML = favoriteColors.map(hex => {
                // Encontrar el nombre del color para accesibilidad
                const colorName = availableColors.find(c => c.hex === hex)?.name || hex;
                const borderClass = hex === '#FFFFFF' ? 'border border-gray-300' : '';
                return `<span title="${colorName}" class="w-4 h-4 rounded-full" style="background-color: ${hex}; ${borderClass}"></span>`;
            }).join('');

            // M√≥dulo de Perfil y Configuraci√≥n (Personalizaci√≥n)
            const perfilContent = `

                <!-- Tarjeta de Usuario -->
                <section class="stylia-card p-6 mb-6 flex items-center space-x-4">
                    <div class="w-16 h-16 bg-stylia-pink rounded-full flex items-center justify-center text-3xl font-bold text-white shadow-lg">
                        ${userName.charAt(0)}
                    </div>
                    <div>
                        <p class="text-xl font-bold text-gray-800">${userName}</p>
                        <p class="text-sm text-gray-500">${userEmail}</p>
                        <p class="text-xs text-gray-400 mt-1">Miembro desde: ${memberSince}</p>
                    </div>
                </section>

                <!-- Preferencias y Estilo (USANDO VARIABLES DE ESTADO) -->
                <section class="stylia-card p-5 mb-6 space-y-3">
                    <h3 class="text-lg font-bold text-stylia-pink">Mis Preferencias STYLIA</h3>
                    
                    <div class="flex justify-between items-center border-b pb-2">
                        <p class="font-medium text-gray-700">Estilo Actual Sugerido:</p>
                        <p class="text-stylia-purple font-semibold">${currentStyle}</p>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <p class="font-medium text-gray-700">Talla de Camiseta:</p>
                        <p class="text-gray-600">${tshirtSize}</p>
                    </div>
                    <div class="flex justify-between items-center">
                        <p class="font-medium text-gray-700">Colores Favoritos (${favoriteColors.length}):</p>
                        <div class="flex space-x-1">
                            ${colorCirclesHTML}
                        </div>
                    </div>

                    <button onclick="openPreferencesModal()" class="w-full text-xs text-gray-600 border border-gray-300 bg-gray-50 p-2 rounded-lg mt-3 stylia-btn-secondary">
                        Editar Preferencias
                    </button>
                </section>

                <!-- Configuraci√≥n de la App -->
                <section class="stylia-card p-5 space-y-3 mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Configuraci√≥n</h3>
                    
                    <div class="flex justify-between items-center">
                        <p class="text-sm text-gray-700">Notificaciones Push</p>
                        <!-- Interruptor de ejemplo -->
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-stylia-purple peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-stylia-purple"></div>
                        </label>
                    </div>
                </section>
                
                <!-- Bot√≥n de Cerrar Sesi√≥n (Separado) - INTERACTIVO -->
                <section class="stylia-card p-3">
                    <button onclick="handleLogout()" class="w-full text-sm text-red-600 border border-red-300 bg-red-50 p-3 rounded-full stylia-btn-secondary">
                        Cerrar Sesi√≥n
                    </button>
                </section>
            `;
            return perfilContent;
        }

        // --- L√ìGICA DE NAVEGACI√ìN ---

        function showModule(moduleName) {
            
            // 1. CONTROL DE AUTENTICACI√ìN: Si no est√° logueado, forzar la vista de autenticaci√≥n.
            if (!isLoggedIn && moduleName !== 'auth') {
                return showModule('auth'); 
            }
            
            // 2. Desactivar todos los botones de la barra de navegaci√≥n y activar el seleccionado
            Object.values(navButtons).forEach(btn => {
                if (btn) btn.classList.remove('nav-active');
            });
            const activeNav = navButtons[moduleName];
            if (activeNav) {
                activeNav.classList.add('nav-active');
            }

            // 3. Renderizar el contenido
            let contentHTML = '';
            switch (moduleName) {
                case 'auth':
                    contentHTML = renderAuthModule();
                    break;
                case 'look':
                    contentHTML = renderLookModule();
                    break;
                case 'armario':
                    contentHTML = renderArmarioModule();
                    break;
                case 'estadisticas':
                    contentHTML = renderEstadisticasModule();
                    break;
                case 'compra':
                    contentHTML = renderCompraModule();
                    break;
                case 'notificaciones':
                    contentHTML = renderNotificacionesModule();
                    break;
                case 'perfil':
                    contentHTML = renderPerfilModule();
                    break;
                default:
                    contentHTML = '<div class="text-center p-10 text-gray-500">M√≥dulo no encontrado.</div>';
            }

            contentDiv.innerHTML = contentHTML;
            // Scroll al inicio del contenido
            contentDiv.scrollTop = 0;
            
            // Si es el m√≥dulo Look, asegura la consistencia de la selecci√≥n inicial
            if (moduleName === 'look') {
                setTimeout(() => {
                    const select = document.getElementById('eventSelect');
                    if(select) {
                        select.value = currentEvent;
                    }
                }, 0);
            }
        }

        // Inicializaci√≥n: Mostrar el m√≥dulo 'look' por defecto al cargar la p√°gina
        window.onload = function() {
            // Asegurarse de que la UI es correcta en funci√≥n del estado inicial
            if(isLoggedIn) {
                showModule('look');
            } else {
                handleLogout(); // Ir a la pantalla de Auth si no est√° logueado
            }
        };
    </script>
</body>
</html>
